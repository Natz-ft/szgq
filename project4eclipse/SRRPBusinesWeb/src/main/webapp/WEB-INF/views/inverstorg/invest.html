
<%@page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html>
<!-- 防止IE提示允许阻止的内容-->
<!-- saved from url=(0014)about:internet -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
      <title>投资</title>
    <script src="../static/script/autoload.js" type="text/javascript"></script>
    <script src="../static/script/autoLoadStyle.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../static/style/page/form.css">
    <style>
          .boxWrap {
            width: 896px;
            margin: 0;
          }
          .layui-form-select .layui-input {
             height: 22px;
			 line-height: 22px;
          }

          .layui-input, .layui-select, .layui-textarea{
           border:1px solid #8DBDDC;
           border-radius: 5px;
           height: 22px;
		   line-height: 22px;
           margin-left: 3px;
           margin-top: 7px;
          }

          .boxWrap .formWrap {
            padding: 60px 20px;
          }

          .investAmount {
            float: left;
            display: block;
            padding: 9px 15px;
            width: 80px;
            font-weight: 400;
            text-align: right;
            line-height: 20px;
            left:15px;
            position: relative;
          }
         
         .org {
            float: left;
            display: block;
            padding: 9px 0px;
            width: 60px;
            font-weight: 400;
            text-align: right;
            line-height: 20px;
            left:8px;
            position: relative;
          }

          .layui-input-block1 {
            margin-left: 30px;
            min-height: 36px;
            position: relative;
          }

          .layui-input-inline1 {
            float: left;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
            left: 13px;
            position: relative;
           }
          
          .layui-input-inline2 {
            float: left;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            left: 13px;
            position: relative;
           }
          
          .layui-input-inline3 {
            float: left;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            left: 11px;
            position: relative;
           }
          .layui-form-mid1 {
            float: left;
            display: block;
            padding: 8px 0!important;
            margin-right: 10px;
            line-height: 20px;
            position: relative;
            left:13px;
           }
          
          .addClass{
            float: left;
            display: block;
            padding: 4px 15px;
            width: 20px;
            font-weight: 400;
            text-align: right;
            line-height: 20px;
            left:2px;
            position: relative;
          }
          
          
          .layui-form-label1 {
            padding: 10px 0px;
            padding-top: 10px;
            padding-right: 0px;
            padding-bottom: 10px;
            padding-left: 0px;
            width: 100px;
            float: left;
            left:13px;
            display: block;
            font-weight: 400;
            text-align: right;
            line-height: 20px;
            position: relative;
          }
          
          .layui-input1{
            display: block;
            width: 80%;
            padding-left: 10px;
            height: 22px;
            border: 1px solid #8DBDDC;
            border-radius: 5px;
    		box-sizing: border-box;
		   }
    </style>
</head>
<body>
<!--头部logo以及登录注册开始-->
<div class="boxWrap">
	<!--<p class="boxTitle">投资</p>-->
    <div class="formWrap">
        <form class="layui-form">
          <!--隐藏域Id-->
          <input type="hidden" name="eventId" value='${eventId}' />
          <input type="hidden" name="infoId" value='${infoId}'/>
          <input type="hidden" name="status" id="status" value='${status}' />
          <input type="hidden" name="multi" id ="multi" value='${multi}' />
          <input type="hidden" name="operType" id="operType" value='${operType}' />
          <c:if test='${operType=="investor"}'>
           <div class="layui-form-item heightAuto">
                <div class="layui-input-block">
                    <label class="investAmount" ><span class="star">*</span>投资金额：</label>
                    <div class="layui-input-inline formEleSplice" >
                        <input type="text" name="amount" id="amount" value='' maxlength="15" required lay-verify="amount"   autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid" style="color: red;" >万元</div>
                    <div class="layui-input-inline formEleSpliceUnit" >
                        <select name="currency"  id="Tcurrency" lay-verify="required" lay-search="" lay-filter="selectFilter">
                            <option value=''>请选择</option>
                            <c:forEach items='${ddCurrency}' var="d">
                                  <option value='${d.dicCode}' >${d.dicName}</option>
                            </c:forEach>
                        </select>
                    </div>
                    <label class="investAmount" style="width: 100px;"><span class="star">*</span>股权比例(%)：</label>
                    <div class="layui-input-inline formEleSplice" >
                        <input type="text" name="ratio" id="ratio" value='' maxlength="8" required lay-verify="ratio"   autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
           </c:if>   
           <c:if test='${operType=="loan"}'>
             <div class="layui-form-item heightAuto">
                <div class="layui-input-block">
                    <label class="layui-form-label"><span class="star">*</span>出资金额：</label>
                    <div class="layui-input-inline formEleSplice">
                        <input type="text" name="amount" id="loanAmount" value='' maxlength="15" required lay-verify="amount" autocomplete="off" class="layui-input">
                    </div>
                    <div class="layui-form-mid" style="color: red;">万元</div>
                    <div class="layui-input-inline formEleSpliceUnit" style="">
                        <select name="currency" lay-verify="required" id="Ccurrency"  lay-search="" lay-filter="selectFilter">
                           <option value='' >请选择币种</option>
                           <c:forEach items='${ddCurrency}' var="d">
                                  <option value='${d.dicCode}' >${d.dicName}</option>
                            </c:forEach>
                        </select>
                    </div>
                    <label class="layui-form-label"><span class="star">*</span>出资时间：</label>
                    <div class="layui-input-inline formEleSplice">
                        <input type="text" name="loanTime"  value='' required lay-verify="loanTime" autocomplete="off" style="width: 150px;" class="layui-input" id="focusDate">
                    </div>
                </div>
            </div>
           </c:if>
           <c:if test='${operType=="push"}'>
           <div class="layui-form-item heightAuto">
               <div class="layui-input-block1">
                    <label class="layui-form-label"><span class="star">*</span>信息标题：</label>
                    <div class="layui-input-block">
                        <input type="text" name="infotitle" id="infotitle" value='' required lay-verify="infotitle" autocomplete="off" class="layui-input1">
                    </div>
               </div>
               <div class="layui-form-item heightAuto">
                   <div class="layui-input-block1">
                        <label class="layui-form-label"><span class="star">*</span>信息类型：</label>
                        <div class="layui-input-block" style="width:188px;margin-top: 16px;">
                            <select name="infotype"  id="infotype" lay-verify="required"  lay-search="" lay-filter="selectFilter">
                                 <c:forEach items='${ddPublishtype}' var="p">
                                     <option value='${p.dicCode}'>${p.dicName}</option>
                                 </c:forEach>
                            </select>
                         </div>
                   </div>
               </div>
               <div class="layui-form-item heightAuto">
                       <div class="layui-input-block1">
                            <label class="layui-form-label"><span class="star">*</span>披露内容：</label>
                            <div class="layui-input-block">
                                <textarea name="infocontent" id="infocontent" style="width:80%;height:120px;" required lay-verify="infocontent" class="layui-textarea">${investor.description}</textarea>
                            </div>
                       </div>
               </div>
               <div class="layui-form-item" style="margin-left:4%">
		               <label class="layui-form-label"><span class="star"></span>披露文件：</label>
		               <div class="layui-input-block clearfix">
		               <input type="hidden" id="publishFilePath" name="publishFilePath">
                       <input type="hidden" id="publishFileName" name="publishFileName" >   
		                   <button type="button" class="layui-btn layui-btn-small uploadButton" id="productUploadBtn">
		                      <i class="layui-icon">&#xe67c;</i>上传文件
		                   </button>
		                   <a  id="publishUploadFile"lay-verify name = "publishUploadFile" download=""  href=""></a>
		               </div>
		      </div>
             </div>
           </c:if>
            <div class="layui-form-item">
                <div class="layui-input-block buttonWrap">
                    <button class="layui-btn submitBtn" lay-submit lay-filter="investAmountForm">&nbsp;&nbsp;提&nbsp;&nbsp;&nbsp;交&nbsp;&nbsp;</button>
                  <!-- <c:if test='${multi=="0" and operType=="investor"}'>
                    <button type="button" id="addBtn" class="layui-btn">&nbsp;&nbsp;添&nbsp;加&nbsp;机&nbsp;构&nbsp;&nbsp;</button>
                  </c:if>  --> 
                    <button type="button" lay-close class="layui-btn closeBtn">&nbsp;&nbsp;关&nbsp;&nbsp;&nbsp;闭&nbsp;&nbsp;</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="../static/script/autoLoadScript.js" type="text/javascript"></script>
<script>
    $(function () {
    	var status = $("#status").val();
    	var operType = $("#operType").val();
    	var multi = $("#multi").val();
    	var followInvest = "";
    	var selected = "true";
    	if(operType=='investor'){
    		document.title="出资";
    	}
    	var operTypenew="";
    	var num = 1;
    	 //调用日期控件
        var form,laydate = layui.laydate;
        laydate.render({
            elem: '#focusDate', //指定元素
            value:new Date()
        });
         layui.use('form', function () {
        	form = layui.form;
        	 var lock=true;
            $(".submitBtn").on("click", function (){
            	 var ratioReg=new RegExp("^(((\\d{1,2})[.]((\\d{1,4})?))|100|(?:0|[1-9][0-9]?)|100.00|100.0|100.000|100.0000)$");
            	  var reg=/^\d{1,9}(\.\d{1,6})?$/;
            	  if(operType=='investor'){
            		  var amount = $("#amount").val();
                      var ratio = $("#ratio").val();
            		  if(amount==""||amount==null||amount==undefined){
                    	  layer.msg("投资金额不能为空");
                    	  return false;
                      }else if (!(reg.test(amount))) {
                          layer.msg("投资金额应整数小于10位且最多六位小数的数字");
                          return false;
                      }
            		  var Tcurrency  = $("#Tcurrency").val();
            		  if(Tcurrency==""||Tcurrency==null||Tcurrency==undefined){
            			  layer.msg("请选择投资金额币种");
                    	  return false;
            		  }
            		  if(ratio==""||ratio==null||ratio==undefined){
               			  layer.msg("股权比例不能为空");
               			  return false;
               		  }else if(!(ratioReg.test(ratio))){
               			  layer.msg("股权比例应小于等于100%，且最多填写四位小数");
               			  return false;
               		  }
            		  operTypeNew='loan';
            		  lock = false;
            	  }
                  if(operType=='loan'){
                	  // 表单验证
                	  var loanAmount = $("#loanAmount").val();
                	  var focusDate = $("#focusDate").val();
                	  if(loanAmount==""||loanAmount==null||loanAmount==undefined){
                		  layer.msg("出资金额不能为空");
                		  return false;
                	  }else if (!(reg.test(loanAmount))) {
                          layer.msg("出资金额应整数小于10位且最多六位小数的数字");
                          return false;
                      }
                	  var Ccurrency  = $("#Ccurrency").val();
            		  if(Ccurrency==""||Ccurrency==null||Ccurrency==undefined){
            			  layer.msg("请选择出资金额币种");
                    	  return false;
            		  }
                	  if(focusDate==""||focusDate==null||focusDate==undefined){
                		  layer.msg("出资时间不能为空");
                		  return false;
                	  }
                	  lock = false;
                	  operTypeNew='push';
                  } 
                  if(operType=='push'){
                	  // 表单验证
                 	  var infotitle = $("#infotitle").val();
                 	  var infocontent = $("#infocontent").val();
                 	  var infotype = $("#infotype").val();
                 	  var publishFileName = $("#publishFileName").val();
                 	  if(infotitle==""||infotitle==null||infotitle==undefined){
                 		 layer.msg("信息标题不能为空");
                 		 return false;
                 	  }
                 	 if(infocontent==""||infocontent==null||infocontent==undefined){
                 		 layer.msg("披露内容不能为空");
                 		 return false;
                 	  }
                 	 if(infotype=='1' && (publishFileName == null || publishFileName=='' || publishFileName==undefined)){
                 		layer.msg("请上传披露文件");
                 		return false;
                 	 }
                 	 lock = false;
                 	operTypeNew='push';
                  }
        	    //监听提交
                form.on('submit(investAmountForm)', function (data) {
                	$.ajax({
					   type : "post",
					  async : false,
					    url : "/SRRPBusinesWeb/homeTodo/chechedAmount",											
					   data : {"updateFinacingEvent" : JSON.stringify(data.field)},
					success : function(obj) {
						var result = JSON.parse(obj);
						   if(result=='false'){//如果结果为否的时候进行提示
							  layer.confirm('当前总出资金额大于投资金额，是否继续？',function (index) {
								 update(data);
							  });
					      }else{
					    	 update(data);
					      }
					    }
				     });
                
                	//预计添加ajax进行金额的校验，如果金额大于投资金额进行提示
                	//选择“确定”正常提交选择“取消”不提交数据
                	
                	return false;
                	//如果金额小于投资金额正常提交
                });
           
           });
        });
        
         function update(data){
        	 $.ajax({
				   type : "post",
				  async : false,
					   url : "/SRRPBusinesWeb/homeTodo/updateFinacingEvent",											
				   data : {"updateFinacingEvent" : JSON.stringify(data.field)},
				success : function(data) {
						parent.location.href="/SRRPBusinesWeb/homeTodo/sendHomeTodo?operType="+operTypeNew;
						var index =layer.getFrameIndex(window.name); //获取窗口索引
						layer.closeAll(index); //关闭layer(关闭当前窗口)
		                return false;
				      },
				  error : function(request) {
					layer.msg("提交失败啦，请稍后再试！");
				   }
			     });
         }
      // 上传文件控件
         var upload = layui.upload;
         //指定允许上传的主要技术产品证明材料
         var  creditAuthUpload=upload.render({
              elem: '#productUploadBtn'//绑定元素
              //, exts: 'jpg|jpeg|png|bmp|gif|txt|TXT|xls|XLS|xlsx|docx|doc|pdf'
              ,data : {"fileType" : 'plcl'}//文件类型为披露材料
              , url: '/SRRPBusinesWeb/index/fileUpload' //上传接口
              , accept: 'file' //普通文件
              , auto: false
              , size: 1024 * 128  //设置文件上传的大小最大为128M
              , before: function () {
                  $("#publishUploadFile").text("文件上传中请稍候…………");
                  document.getElementById("publishUploadFile").style.color = '#FF6838';
              }
              ,choose: function(obj){
                  //将每次选择的文件追加到文件队列
                  var files = obj.pushFile();
                  //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                  obj.preview(function(index, file, result){
                    if(file.size == 0){
                  	  $("#publishUploadFile").text("请上传非空文件！");
                  	  document.getElementById("publishUploadFile").style.color = '#FF6838';
                    }else{
                  	  obj.upload(index, file);
                    }
                  });
                }
              , done: function (res) {
                  if (res.code == 0) {
                      document.getElementById("publishUploadFile").style.color = 'black';
                      $("#publishFilePath").attr("value", res.url);
                      $("#publishFileName").attr("value", res.name);
                      $("#publishUploadFile").text(res.name)
                      $("#publishUploadFile").attr("href",res.url);
                      $('#publishUploadFile').attr('download',res.name);
                  }else{
                  	$("#publishUploadFile").text("请上传非空文件！");
                  }
              }
          });
        $(".closeBtn").on("click", function () {
        	 var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
             parent.layer.close(index); //关闭layer(关闭当前窗口)
        })
    })
</script>
</body>
</html>