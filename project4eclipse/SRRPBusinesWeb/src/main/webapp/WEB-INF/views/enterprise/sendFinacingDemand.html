<%@page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <metaname="renderer" content="webkit|ie-comp|ie-stand">
    <title>发布投资需求</title>
    <script src="../static/script/autoload.js" type="text/javascript"></script>
    <script src="../static/script/autoLoadStyle.js" type="text/javascript"></script>
    <script src="../static/script/my97/WdatePicker.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../static/style/page/form.css">
</head>
<style>
    .scaletext {
        margin-top: -31px;
        margin-left: 120px;
        width: 140px;
        border: 1px solid #8DBDDC;
        border-radius: 5px;
        padding-left: 5px;
    }
    .scaletext-end {
        margin-top: -28px;
        margin-left: 205px;
        width: 140px;
        border: 1px solid #8DBDDC;
        border-radius: 5px;
        padding-left: 5px;
    }
    .optiondiv {
        width: 90px;
    }

    .form-input {
        width: 280px;
        height: 24px;
        border: 1px solid #8DBDDC;
        border-radius: 5px;
        margin-left: 6px;
        margin-top: 3px;
        padding-left: 5px;
    }
     .layui-form-select .layui-input {
         height: 24px;
     }
    .form-select {
        height: 24px;
        border: 1px solid #8DBDDC;
        border-radius: 4px;
        margin-left: 6px;
        margin-top: 6px;

    }
    /*选择机构样式*/
    .checked-org{
        /*width:80%;*/
        border: solid 1px #E9F3F7;
        background: #E9F3F7;
        vertical-align: middle;
    }
	
	 .checked-org-other{
        /*width:80%;*/
		margin-left:50px;
        border: solid 1px #E9F3F7;
        background: #E9F3F7;
        vertical-align: middle;
    }
    .checked-org-after-deletebtn{
        vertical-align: middle;
        width: 21px;
        height: 21px;
    }
    .demo-class .layui-layer-btn{background:#eeeeee;}
</style>
<body >
<!--头部logo以及登录注册开始-->
<div class="boxWrap">
<!--2018年1月9日 09:27:24    LIWC    添加判断当发布需求的时候显示发布需求，修改需求的时候，显示编辑需求 -->
<a href="javascript:void(0)"  id="select_content" style="color: #FF6838;display:none " >&nbsp;&nbsp;选择机构</a>
    <c:if test="${empty finacingInfo.infoId}">
      <p class="boxTitle"><span>发布需求</span></p>
    </c:if>
    <c:if test="${not empty finacingInfo.infoId}">
      <p class="boxTitle"><span>编辑融资需求</span></p>
    </c:if>
    <div class="boxContent">
        <div class="formWrap">
            <form class="layui-form" enctype="multipart/form-data"> <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
            <input type="hidden" name="projectName" value="${finacingInfo.projectName}">
<!--                 <div class="layui-form-item"> -->
<!--                     <label class="layui-form-label"><span class="star">*</span>项目名称：</label> -->
<!--                     <div class="layui-input-block"> -->
<!--                         <input type="hidden" name="projectName" placeholder="请输入" class="form-input" required -->
<!--                                lay-verify="projectName" value="${finacingInfo.projectName}" autocomplete="off" -->
<!--                                class="layui-input" style="width:250px;"> -->
<!--                     </div> -->
<!--                 </div> -->

                <div class="form-left">
                    <div class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label"><span class="star">*</span>融资金额：</label>
                        <div class="layui-input-block">
                            <div class="layui-input-inline" style="width: 320px;">
                                <input type="text" maxlength="8" name="amountMin" placeholder="请输入" autocomplete="off" class="form-input"
                                       value="<fmt:formatNumber value="${finacingInfo.amountMin*100}" pattern="####.##"/>" style="width: 70px;float:left;">
                                <div class="layui-form-mid">~</div>
                                <input type="text" maxlength="8" name="amountMax" placeholder="请输入" autocomplete="off" class="form-input"
                                       value="<fmt:formatNumber value="${finacingInfo.amountMax*100}" pattern="####.##"/>" style="width: 70px;float:left;">
                            <div class="layui-form-mid">万元</div>
                            <div class="layui-input-inline formEleSpliceUnit form-select" style="margin-top: 2px; height: 24px; width: 72px;">
                                <select name="currency">
                                    <option value="">请选择融资币种</option>
                                    <option value="01" <c:if test="${'01' eq finacingInfo.currency}">selected</c:if>>CNY</option>
                                    <option value="02" <c:if test="${'02' eq finacingInfo.currency}">selected</c:if>>USD</option>
                                </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label"><span class="star">*</span>融资轮次：</label>
                        <div style="margin-left:116px; width: 250px; height: 24px;border: 1px solid #8DBDDC; border-radius: 3px;">
                            <!-- ${finacingInfo.projectName} -->
                            <select name="finacingTurn" lay-filter="financeRound" style="height: 24px;"  >
                                    <option value="" >请选择融资轮次</option>
                                <c:forEach items="${ddFinacingTurn}" var="dfinturn">
                                    <option value="${dfinturn.dicCode}"
                                    <c:if test="${dfinturn.dicCode eq finacingInfo.finacingTurn}">selected</c:if>
                                    >${dfinturn.dicName}</option>
                                </c:forEach>
                            </select>
                        </div>
                    </div>
                    <div id="openIdDiv" class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label"><span class="star">*</span>是否公开：</label>
                        <div style="margin-left:116px;width: 250px;height: 24px;border: 1px solid #8DBDDC; border-radius: 3px;">
                            <select id="open" name="open" style="height: 24px;" lay-filter="open" <c:if test="${finacingInfo.revokeFlag eq '1' || (finacingInfo.revokeFlag eq '0' && finacingInfo.status eq '01')}">disabled="true"</c:if> >
                                <option value="">请选择是否公开</option>
                                <option value="0" <c:if test="${'0'==finacingInfo.open}">selected</c:if>>是</option>
                                <option value="1" <c:if test="${'1' == finacingInfo.open}">selected</c:if> >否</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label"><span class="star">*</span>联系人姓名：</label>
                        <div class="layui-input-block">
                            <input type="text" name="relName" placeholder="请输入" class="form-input"
                                   value="${finacingInfo.relName}" autocomplete="off" class="layui-input" style="width: 250px">
                        </div>
                    </div>
                </div>
                <div class="form-right">
                    <div id="sellIdDiv" class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label"><span class="star" style="margin-left:20px;">*</span>出让股权：</label>
					    <div class="layui-input-block" style="margin-left: 110px;">
					        <div class="layui-input-inline" style="width: 300px;">
					            <div class="layui-input-inline formEleSpliceUnit form-select" style="margin-left:-5px;margin-top: 2px; height: 24px;width: 120px;">
                                <select id="sell" name="sell" >
                                    <option value="" >请选择</option>
                                    <option value="0"
                                    <c:if test="${'0' eq finacingInfo.sell}">selected</c:if>
                                    >原股权转让</option>
                                    <option value="1"
                                    <c:if test="${'1' eq finacingInfo.sell}">selected</c:if>
                                    >增资扩股</option>
                                </select>
					            </div>
						            <div id="sellDiv">
						                <input id="scaleText" type="text" name="scaleMin" maxlength="5" placeholder="请输入"
	                                           class="form-input" value="<fmt:formatNumber value="${finacingInfo.scaleMin}" pattern="##.##"/>" autocomplete="off"
						                       style="width: 50px;float:left;">
						                <div class="layui-form-mid">&nbsp;&nbsp;~</div>
						                <input id="scaleText_end" type="text"  name="scaleMax" maxlength="5" placeholder="请输入"
	                                           class="form-input" value="<fmt:formatNumber value="${finacingInfo.scaleMax}" pattern="##.##"/>" autocomplete="off"
						                       style="width: 50px;float:left;">
						                <div class="layui-form-mid">%</div>
						            </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label" style="width: 150px;margin-left:-50px;"><span
                                class="star">*</span>接受多个机构投资：</label>
                        <div class="layui-input-block">
                            <input type="radio" name="multi" value="0" title="是" checked
                            <c:if test="${'0' eq finacingInfo.multi}">checked</c:if>
                            >
                            <input type="radio" name="multi" value="1" title="否"
                            <c:if test="${'1' eq finacingInfo.multi}">checked</c:if>
                            >
                        </div>
                    </div>
                    <div class="layui-form-item"  style="height: 38px;">
                        <label class="layui-form-label" style="width: 120px;margin-left:-21px;"><span class="star">*</span>联系人手机号：</label>
                        <div style="margin-left:100px;">
                            <input type="text" name="relPhone" maxlength="11" placeholder="请输入" class="form-input"
                                   value="${finacingInfo.relPhone}" style="width: 200px" autocomplete="off"
                                   class="layui-input">
                        </div>
                    </div>
                </div>
                <div style="display: none" id="zhidingOrg">
	                <div class="layui-form-item heightAuto" >
	                    <label class="layui-form-label">指定投资机构：</label>
	                    <div class="layui-input-block">
	                        <a href="javascript:void(0)"  id="select_investors" style="display:inline-block;padding-top: 6px;color: #ff0000" >&nbsp;&nbsp;选择机构</a>
							<div id="investor_record"></div>

	                    </div>
	                </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="star">*</span>需求详情：</label>
                    <div class="layui-input-block">
                        <textarea placeholder="请输入内容" class="layui-textarea" name="description"
                                  style="border: 1px solid #8DBDDC;border-radius: 5px; margin-left: 6px; margin-top:10px; padding-left: 5px;">${finacingInfo.description}</textarea>
                        <div class="layui-form-mid warnNote" style="margin-left: 10px;">
                            <pre style="font-size: 13px;">法律提醒：<br>1.针对公开发布的需求，平台会对发布需求方的企业名称进行加密，建议需求方在需求详情和商业企划书中不要公开企业名称。<br>2.禁止发布、散布、宣扬、危害中国主权、攻击党和国家领导人、故意破坏社会稳定局势、封建迷信等法律、行政法规禁止的其他内容。</pre>
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="star">*</span>商业企划书：</label>
                    <input type="hidden" id="fileupHidden" name="fileUpdatePath" value="${companyBusinessplan.fileinfo}" autocomplete="off"
                           class="layui-input">
                    <input type="hidden" id="fileName" name="fileName" value="${companyBusinessplan.fileName}">       
                    <button type="button" class="layui-btn" id="updateFile">
                        <i class="layui-icon"> </i>上传文件
                    </button><a id="downloadFile" style="color: black;;margin-left:3px;" download="${companyBusinessplan.fileName}"
                                    href="${companyBusinessplan.fileinfo}">${companyBusinessplan.fileName}
	                  </a>
                </div>
<!--                 <div class="form-right"> -->
<!--                     <div style="width:auto;margin-top:-15%;margin-left:-91%;"> -->
<!--                         <p><span><a id="downloadFile" style="color: black" download="${companyBusinessplan.fileName}" -->
<!--                                     href="${companyBusinessplan.fileinfo}">${companyBusinessplan.fileName} -->
<!-- 	                  </a></span></p> -->
<!--                     </div> -->
<!--                 </div> -->
                <input type="text" name="appointInvestor" id="investorIdList" autocomplete="off" class="layui-input"
                       style="display: none;" value=${investorIdList}>
                <input type="text" name="infoId" id="investorIdList" autocomplete="off" class="layui-input"
                       style="display: none;" value=${finacingInfo.infoId}>
                <c:if test="${not empty finacingInfo.status}">
                    <input type="text" name="status" id="status" autocomplete="off" class="layui-input"
                           style="display: none;" value=${finacingInfo.status}>
                </c:if>
                <c:if test="${not empty finacingInfo.revokeFlag}">
                    <input type="text" name="revokeFlag" id="revokeFlag" autocomplete="off" class="layui-input"
                           style="display: none;" value=${finacingInfo.revokeFlag}>
                </c:if>
                <div class="layui-form-item">
                    <div class="layui-input-block buttonWrap">
                        <c:if test="${empty finacingInfo.infoId}">
                            <button class="layui-btn publishBtn" value="upload" lay-submit lay-filter="publishForm">
                                &nbsp;&nbsp;发&nbsp;&nbsp;&nbsp;布&nbsp;&nbsp;
                            </button>
                            <button type="button" value="upload" class="layui-btn  saveFinacingDemandBtn" lay-submit
                                    lay-filter="saveForm">&nbsp;&nbsp;暂&nbsp;&nbsp;&nbsp;存&nbsp;&nbsp;
                            </button>
                            <button type="reset" class="layui-btn "> &nbsp;&nbsp;重&nbsp;&nbsp;&nbsp;置&nbsp;&nbsp;
                            </button>
                        </c:if>
                        <c:if test="${not empty finacingInfo.infoId}">
                            <button class="layui-btn updateBtn" value="upload" lay-submit lay-filter="updateForm">&nbsp;&nbsp;确&nbsp;&nbsp;&nbsp;认&nbsp;&nbsp;</button>
                            <button type="button" lay-close class="layui-btn layui-btn-primary closeBtn">&nbsp;&nbsp;关&nbsp;&nbsp;&nbsp;闭&nbsp;&nbsp;</button>
                        </c:if>

                    </div>
                </div>
            </form>


        </div>
    </div>
</div>
<script src="../static/script/autoLoadScript.js" type="text/javascript"></script>
<script src="../portal/register/script/formValidatorRegex.js" type="text/javascript"></script>
<script>
var form = layui.form;
var open = "${finacingInfo.open}";
var orgV = document.getElementById("zhidingOrg");
if(open=='1'){
	orgV.style.display = 'inline'; //展示审核意见
}else{
	orgV.style.display = 'none'; //展示审核意见
}
//构造一个传参用的
var investorIdList ='';
var oldinvestor='${investorIdList}';
var investorNameList ='';
var checkallLen = 0;
var checkoneLen = 0;
var oldsize=0;
var isShow="${isShow}";
if (isShow == "true") {
	window.location.href = "/SRRPBusinesWeb/enterprise/enterpriseDetail";
    window.parent.parent.document.getElementById('leftFrame').contentWindow.menu_sendToEnter_handle();//需要调用的方法;
}

form.on('select(open)', function(data){
	if(data.value=='1'){
		 if (orgV.style.display == "none") {
		    	orgV.style.display = 'inline'; //展示审核意见
		    }
		 
	}else{
		if (orgV.style.display == "inline") {
		    	orgV.style.display = 'none'; //展示审核意见
		  }
		$("#investorNameList").val("");
        $("#investorIdList").val("");
        investorIdList="";
        investorNameList="";
        document.getElementById('investor_record').innerHTML="";
	}
	  
	}); 
    $(".saveFinacingDemandBtn").on("click", function () {
        layui.use('form', function (finacingDemandInfo) {
            var form = layui.form;
            var lock = true;
            //监听提交
            //暂存需求
            form.on('submit(saveForm)', function (data) {
                if (!checkData(data)) {
                    return false;
                }
                if (lock != true) {
                    return false;
                }
                var fileUpdatePath = data.field.fileUpdatePath;
                var fileName = data.field.fileName;
                var investorId = data.field.appointInvestor;
                lock = false;
                //页面接受数据为万元，处理成百万
                data.field.amountMin = baiwanToWan(data.field.amountMin);
                data.field.amountMax = baiwanToWan(data.field.amountMax);
                submitDemand(data,investorId,fileUpdatePath,fileName,'publish');
                return false;
            });
        });
    });
    $("#select_content").on("click", function () {
    		layer.open({
        	            title:  ['&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;友&nbsp;&nbsp;情&nbsp;&nbsp;提&nbsp;&nbsp;示&nbsp;&nbsp;', 'font-size:22px;text-align:center;'] //不显示标题栏
        				,area: ['60%', '396px']
    		            ,skin: 'demo-class' //加上边框
    	                , type: 1
    	                ,offset: '40px'
    	                , btnAlign: 'c'
    	                , btn: '&nbsp;&nbsp;关&nbsp;&nbsp;闭&nbsp;&nbsp;'
		        	    ,content: '<div style="padding: 30px; line-height: 20px; background-color: #fff; color: #424242;    font-family: "微软雅黑",sans-serif; font-weight: 600;">	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1. 针对公开发布的需求，平台会对发布需求方的企业名称进行加密，建议需求方在需求详情和商业企划书中不要公开企业名称。	<br>	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2. 禁止发布、散布、宣扬、危害中国主权、攻击党和国家领导人、故意破坏社会稳定局势、封建迷信等法律、行政法规禁止的其他内容。	<br>	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3. 免责声明。	<br>	<div style="margin-left:5%">	本平台明确声明：您需在完全理解并同意接受本声明后方可发布企业需求信息以及从事相关交易。	 <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(1)、一切因在本平台发布信息而引致任何原因包括不限于泄密等所造成的损失，本平台概不负责，亦不承担任何法律责任。         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2)、用户通过本平台发布相关信息产生交易时，请核实对方真实身份及相关资质，以免造成财产损失。您充分理解，您在本平台上发布信息后接洽的投资机构均为第三方机构，由于投资机构信息的隐藏性，请谨慎选择投资机构，遭受的损失与本平台无任何关联         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(3)、您充分理解并接受，收到定向投递的机构（包含该机构下所有基金）可查看发布方包括不限于企业的征信信息。         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(4)、您充分理解并接受，因相关企业通过平台或其他方式向苏州市地方企业征信系统查询或使用企业的相关信息可能导致的任何不利后果,本平台及相关单位不承担任何经济和法律责任。         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(5)、您充分理解并接受，本平台对信息发布的准确性、完整性和真实性不作任何承诺；对信息的迟延、失误和遗漏不承担任何责任。         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(6)、您充分理解并接受，您不得向或从本平台发送任何涉及侮辱、诽谤、造谣的或其他与中国相关法律规定的非法或侵权的材料和信息。本平台没有义务对您输入到本网站上的信息进行监视和/或检查，并且不承担与您输入的信息有关的任何责任和义务，本平台保留完全依其决定不必事先通知且不必说明理由而检查您输入的信息和删除您输入的信息的权利，并无须说明理由。         <br>	    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(7)、您充分理解并接受，本平台不承担您因接入或使用本网站以及各种交易或其他行为而产生的直接、间接、附带的、后继的或特殊的损失。        </div>         请您认真阅读本协议，使用本平台即表示您已充分阅读、理解并接受本声明的全部内容，并自愿接受本协议各项条款的约束。</div>'
		        	    ,yes: function(){
		    	            layer.closeAll();
		        	        }
		        	  });
    		
    })
    //选择投资机构
    $("#select_investors").on("click", function () {
    	var flag="${finacingInfo.revokeFlag}";
    	var status="${finacingInfo.status}";
    	if(flag=='1' ){
    		layer.msg("已撤回的需求，指定投资机构不可以更改！");
    	}else if(status=='01'&&flag=='0' ){
    		layer.msg("已发布的需求，指定投资机构不可以更改！");
    	}else{
    		layer.open({
                title: '发布投资需求-选择投资机构'
                , content: "/SRRPBusinesWeb/investor/selectInvestorList?investorIdList='"+investorIdList+"'&investorNameList='"+encodeURI(encodeURI(investorNameList))+"'"
                , area: ['87%', '90%']
                , offset: ['5%', '5%']
                , type: 2 
                , btnAlign: 'c'
                ,scrollbar: false
                , btn: '提交'
                , yes: function (index,layero) {
                    var body = layer.getChildFrame();
                    $(layero).find('iframe')[0].contentWindow.getcheild();
                    console.log("checkoneLen========="+checkoneLen );
                    console.log("checkallLen========="+checkallLen );
                    if ((checkoneLen >10 || checkallLen >10)||( checkallLen >10 &&checkoneLen >0 )) {
                        layer.msg("选择机构超过10个，请重新选择！");
                    } else {
                    	if(oldsize>0 && checkoneLen==0 && checkallLen==0){
                    		layer.close(index);
                    	}else if(checkoneLen==0 && checkallLen==0){//2018年1月10日 14:07:06   LIWCH   添加当没有选择机构的情况下进行提示不做任何操作
                    		layer.msg("至少选择1个投资机构！");
                    	}else{
                    		 get_investor_record();
                    		 $("#investorNameList").val(investorNameList);
                             $("#investorIdList").val(investorIdList);
                             //最后关闭弹出层
                             layer.close(index);
                    	}
                    }
                }
            });
    	}
        

    });

    //拼接选中的机构investor_record
    function get_investor_record() {
        //分割investorNameList investorIdList
        var investorNameLists=investorNameList.split("   ");
        var investorIdLists=investorIdList.split(",");
	
        var arr="";
		var re= /[^\x00-\xff]/ ;
        //根据investorNameLists遍历,封装好investor_record的value值arr
	    var checked_org_totle_len=0;
		var checked_org_totle_br_len=0;
		var checked_org_second_line=0;
		var checked_org_third_line=0;
        for(var i=0;i<investorNameLists.length;i++){
            var id=investorIdLists[i+1].trim();
            var name=investorNameLists[i].trim();
			var byteCount=0; 
			for(var j=0;j<name.length;j++){
			    var c=name.charAt(j);
				if(re.test(c)){
				    byteCount+=2;
				}else{
				    byteCount+=1;
				}
			}
            //根据字符串的长度得到text的宽度			
            var checked_org_len = byteCount*7.5 + 'px';
			checked_org_totle_len+= byteCount*7.5+50+21;
			if(i==0){//第一个的显示
				arr+= '<input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
				   +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';
			}else{//不是第一个的显示
				if(checked_org_totle_len>810){//判断是否显示二行
					  checked_org_totle_br_len+= byteCount*7.5+50+21;
					if(checked_org_totle_len<1510){//判断是否需要显示第三行，如果不需要直接显示第二行
						if(checked_org_totle_br_len<810&&checked_org_second_line==0){
						    checked_org_second_line=1;
						    arr+='</br><input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
							 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
						  }else{					  
						    arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
							 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
						  }
					}else{//如果需要进行第三行的显示
						if(checked_org_totle_br_len<1510 && checked_org_third_line==0){
							checked_org_third_line=1;
						    arr+='</br><input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
							 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
						  }else{	
						    arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
							 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
						  }
					}
				}else{//第一行其他名称显示
					  arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
						 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';
				}
			}
        }
        //赋值给div id=investor_record
        document.getElementById('investor_record').innerHTML=arr;
    }
    //执行删除("删除选中的机构")操作
    function performDelete(id) {
    	var flag="${finacingInfo.revokeFlag}";
    	var status="${finacingInfo.status}";
    	if(flag=='1' || (status=='01'&&flag=='0' )){
    		layer.msg("已撤回的需求，不可以修改投资机构！");
    		return false;
    	}else if(status=='01'&&flag=='0' ){
    		layer.msg("已发布的需求，不可以修改投资机构！");
    		return false;
    	}else{
        //分割investorNameList investorIdList
        var investorNameLists = investorNameList.split("   ");
        var investorIdLists = investorIdList.split(",");
        var arr = "";
        var delete_index;//点击删除的下标
        //第一步：得出要删除的下标
        for (var i = 0; i < investorIdLists.length; i++) {
            if (investorIdLists[i + 1] != undefined && investorIdLists[i + 1] != null
                && investorIdLists[i + 1] != "" && id == investorIdLists[i + 1]) {
                delete_index = i;
            }
        }
        //第二步：执行删除操作-splice方法
        investorIdLists.splice(delete_index + 1, 1);
        investorNameLists.splice(delete_index, 1);
        //第三步：重新定义investorIdList investorNameList
        investorIdList = "";
        investorNameList = "";
        //第四步：根据investorNameLists遍历,重新定义investorIdList investorNameList
        for (var i = 0; i <= investorNameLists.length; i++) {
            if (investorIdLists[i + 1] != undefined && investorIdLists[i + 1] != null && investorIdLists[i + 1] != ""
                && investorNameLists[i] != undefined && investorNameLists[i] != null && investorNameLists[i] != "") {
                investorIdList += "," + investorIdLists[i + 1];
//                 if (i == 0) {
//                     investorNameList = investorNameLists[i].trim();
//                 } else {
                    investorNameList = investorNameList + " " + investorNameLists[i].trim()+"  ";
//                 }
            }
        }
        //第五步：根据investorNameLists遍历,重新封装好investor_record的value值arr(investor_record)
		var checked_org_totle_len=0;
		var checked_org_totle_br_len=0;
		var checked_org_second_line=0;
		var checked_org_third_line=0;
        for (var i = 0; i < investorNameLists.length; i++) {
            if (investorIdLists[i + 1] != undefined && investorIdLists[i + 1] != null && investorIdLists[i + 1] != ""
                && investorNameLists[i] != undefined && investorNameLists[i] != null && investorNameLists[i] != "") {
                var id=investorIdLists[i+1].trim();
                var name=investorNameLists[i].trim();
				
				var byteCount=0;
				var re= /[^\x00-\xff]/ ; 
				for(var j=0;j<name.length;j++){
					var c=name.charAt(j);

					if(re.test(c)){
						byteCount+=2;
					}else{
						byteCount+=1;
					}
				}

                //根据字符串的长度得到text的宽度			
				var checked_org_len = byteCount*7.5 + 'px';
				checked_org_totle_len+= byteCount*7.5+50+21;
				if(i==0){
					arr+= '<input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
					   +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';

				}else{
					if(checked_org_totle_len>810){//判断是否显示二行
						  checked_org_totle_br_len+= byteCount*7.5+50+21;
						if(checked_org_totle_len<1610){//判断是否需要显示第三行，如果不需要直接显示第二行
							if(checked_org_totle_br_len<810&&checked_org_second_line==0){
							    checked_org_second_line=1;
							    arr+='</br><input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
								 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
							  }else{					  
							    arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
								 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
							  }
						}else{//如果需要进行第三行的显示
							if(checked_org_totle_br_len<1610 && checked_org_third_line==0){
								checked_org_third_line=1;
							    arr+='</br><input type="text"  class="checked-org"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
								 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
							  }else{	
							    arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
								 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';					
							  }
						}
					}else{//第一行其他名称显示
						  arr+='<input type="text"  class="checked-org-other"  readonly value="'+name+'"  id="'+id+'"  style="width: '+checked_org_len+'"/>'
							 +'<input  class="checked-org-after-deletebtn"   onclick="return performDelete(this.id)"   title="删除"   src="../static/images/delete.png" id="'+id+'" type="image"/>';
					}
				}

            }
        }
        //第六步：赋值给div id=investor_record
        document.getElementById('investor_record').innerHTML = arr;
        //第七步：重新定义investorNameList investorIdList便于传值
        $("#investorNameList").val(investorNameList);
        $("#investorIdList").val(investorIdList);
    	
    	}
    }


    $(".closeBtn").on("click", function () {
        var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
        window.location.href = "/SRRPBusinesWeb/finacingDemand/demandList"; //(刷新父级窗口)
        window.parent.parent.document.getElementById('leftFrame').contentWindow.menu_send_handle();//需要调用的方法;
        parent.layer.close(index); //关闭layer(关闭当前窗口)
    });
    
    function baiwanToWan(baiwan){
    	return baiwan/100;
    }

    $(".publishBtn").on("click", function () {
        layui.use('form', function (finacingDemandInfo) {
            var form = layui.form;
            var lock = true;
            //向机构投递需求
            form.on('submit(publishForm)', function (data) {
                if (!checkData(data)) {
                    return false;
                }
                if (lock != true) {
                    return false;
                }
                lock = false;
                var investorId = data.field.appointInvestor;
                var fileUpdatePath = data.field.fileUpdatePath;
                var fileName = data.field.fileName;
                var open =data.field.open;
                //页面接受数据为万元，处理成百万
                data.field.amountMin = baiwanToWan(data.field.amountMin);
                data.field.amountMax = baiwanToWan(data.field.amountMax);
                submitDemand(data,investorId,fileUpdatePath,fileName,'save');
                return false;
            });
        });
    });

    //修改需求的确认功能
    $(".updateBtn").on("click", function () {
        layui.use('form', function (finacingDemandInfo) {
            var form = layui.form;
            //向机构投递需求
            form.on('submit(updateForm)', function (data) {
                var investorId = data.field.appointInvestor;
                if (!checkData(data)) {
                    return false;
                }
                var fileUpdatePath = data.field.fileUpdatePath;
                var fileName = data.field.fileName;
                //页面接受数据为万元，处理成百万
                data.field.amountMin = baiwanToWan(data.field.amountMin);
                data.field.amountMax = baiwanToWan(data.field.amountMax);
                updateDemand(data,investorId,fileUpdatePath,fileName)
                return false;
            });
        });
    });
    function submitDemand(data,investorId,fileUpdatePath,fileName,operType) {
    	if(operType=='save'){
    		layer.confirm('是否确认发布？一旦发布，是否公开和指定投资机构选项将不能修改。',{icon: 3, title:'提示',btnAlign: 'c'},function(index){
	        	 $.ajax({
	        	     type: "post",
	        	     async: false,
	        	     url: "/SRRPBusinesWeb/finacingDemand/sendFinancingDemand",
	        	     data: {
	        	         "finacingDemandInfo": JSON.stringify(data.field),
	        	         "investorIdList": investorId,
	        	         "fileUpdatePath": fileUpdatePath,
	        	         "fileName":fileName,
	        	         "operType":operType
	        	     },
	        	     success: function (data) {
	        	    	 var msg='需求暂存成功';
	        	    	 if(operType=='save'){
	        	    		 msg = '需求发布成功'
	        	    	 }
	                     layer.alert(msg, {icon: 1},function(){
	                    	 if(oldinvestor==''){//判断是否有投资机构的列表传过来，如果有的话就入口为机构相关的按钮
	                        	 window.location.href = "/SRRPBusinesWeb/finacingDemand/demandList";
	                         }else{
	                        	 window.parent.location.href = "/SRRPBusinesWeb/finacingDemand/demandList";
	                         }
	            	         window.parent.parent.document.getElementById('leftFrame').contentWindow.menu_send_handle();//需要调用的方法;
	                     });
	        	     }
	        	 });
	        });
    	}else{
    		 $.ajax({
        	     type: "post",
        	     async: false,
        	     url: "/SRRPBusinesWeb/finacingDemand/sendFinancingDemand",
        	     data: {
        	         "finacingDemandInfo": JSON.stringify(data.field),
        	         "investorIdList": investorId,
        	         "fileUpdatePath": fileUpdatePath,
        	         "fileName":fileName,
        	         "operType":operType
        	     },
        	     success: function (data) {
        	    	 var msg='需求暂存成功';
        	    	 if(operType=='save'){
        	    		 msg = '需求发布成功'
        	    	 }
                     layer.alert(msg, {icon: 1},function(){
                    	 if(oldinvestor==''){//判断是否有投资机构的列表传过来，如果有的话就入口为机构相关的按钮
                        	 window.location.href = "/SRRPBusinesWeb/finacingDemand/demandList";
                         }else{
                        	 window.parent.location.href = "/SRRPBusinesWeb/finacingDemand/demandList";
                         }
            	         window.parent.parent.document.getElementById('leftFrame').contentWindow.menu_send_handle();//需要调用的方法;
                     });
        	     }
        	 });
    	}
    	
    }
    function updateDemand(data,investorId,fileUpdatePath,fileName){
    	$.ajax({
            type: "post",
            async: false,
            url: "/SRRPBusinesWeb/finacingDemand/updateFinacingInfo",
            data: {
                "finacingDemandInfo": JSON.stringify(data.field),
                "investorIdList": investorId,
                "fileUpdatePath": fileUpdatePath,
                "fileName":fileName
            },
            success: function (data) {
             layer.alert('需求更新成功', {icon: 1},function(){
            	  window.parent.location.href = "/SRRPBusinesWeb/finacingDemand/demandList";
       	         window.parent.parent.document.getElementById('leftFrame').contentWindow.menu_send_handle();//需要调用的方法;
             });
            }
        });
    }
    function checkData(data) {
        if (data.field.amountMin === '' || data.field.amountMin === '0'|| data.field.amountMin === '0.00') {
            layer.msg("请输入融资金额", {icon: 5});
            return false;
        }
        if (data.field.amountMax === '' || data.field.amountMax === '0'||data.field.amountMin === '0.00') {
            layer.msg("请输入融资金额", {icon: 5});
            return false;
        }
        if (!(/^\d+(\.\d{1,2})?$/.test(data.field.amountMin))) {
            layer.msg("请输入正确的融资金额", {icon: 5});
            return false;
        }
        if (!(/^\d+(\.\d{1,2})?$/.test(data.field.amountMax))) {
            layer.msg("请输入正确的融资金额", {icon: 5});
            return false;
        }
		if (data.field.amountMin>=10000) {
            layer.msg("融资金额不能超过1百亿", {icon: 5});
            return false;
        }
		if (data.field.amountMin>=10000) {
            layer.msg("融资金额不能超过1百亿", {icon: 5});
            return false;
        }
		if (data.field.currency === '') {
            layer.msg("请选择融资币种", {icon: 5});
            return false;
        }
        if(parseInt(data.field.amountMin) > parseInt(data.field.amountMax)){
            layer.msg("请正确输入融资金额范围", {icon: 5});
            return false;
        }
        if(data.field.sell === ''){
        	layer.msg("请选择出让股权方式", {icon: 5});
            return false;
        }
        if(data.field.scaleMin === ''||data.field.scaleMax === ''){
            layer.msg("出让股权数不能为空", {icon: 5});
            return false;
    	}
    	if (/[^\d.]/g.test(data.field.scaleMin)) {
            layer.msg("出让股权数只能是数字", {icon: 5});
            return false;
        }
        if (/[^\d.]/g.test(data.field.scaleMax)) {
            layer.msg("出让股权数只能是数字", {icon: 5});
            return false;
        }
    	if(0 >= data.field.scaleMin || data.field.scaleMin > 101 || 0 >= data.field.scaleMax || data.field.scaleMax > 101){
	        layer.msg("出让股权，请输入0-100之间的数字", {icon: 5});
	        return false
    	}
    	if(parseInt(data.field.scaleMin) > parseInt(data.field.scaleMax)){
            layer.msg("请正确输入出让股权范围", {icon: 5});
            return false
    	}
        if (data.field.finacingTurn === '') {
       	 layer.msg("请选择融资轮次", {icon: 5});
            return false;
       }
        if (data.field.open === '') {
        	 layer.msg("请选择是否公开", {icon: 5});
             return false;
        }
        if (data.field.relName === '') {
            layer.msg("请输入联系人姓名", {icon: 5});
            return false;
        }
        if (data.field.relName.length > 10) {
            layer.msg("联系人姓名不能超过10个字符", {icon: 5});
            return false;
        }
        if (data.field.relPhone === '') {
            layer.msg("请输入联系电话", {icon: 5});
            return false;
        }
        if (!(/^1[3|4|5|7|8][0-9]\d{4,8}$/.test(data.field.relPhone))) {
            layer.msg("请正确输入手机号", {icon: 5});
            return false;
        }
        if(data.field.open == '1'){
        	var	investorIdList= $("#investorIdList").val();
    		if(investorIdList==''||investorIdList==undefined||investorIdList==null){
                layer.msg("请指定投资机构", {icon: 5});
                return false;
            } 
        }
        if (data.field.description === '') {
            layer.msg("请输入需求详情", {icon: 5});
            return false;
        }
        if (data.field.description.length > 1000) {
            layer.msg("需求详情过长，详情不能超过1000个字符", {icon: 5});
            return false;
        }
        if (data.field.fileUpdatePath == '') {
            layer.msg("请上传商业企划书", {icon: 5});
            return false;
        } 
        return true;
    }
</script>
<!--  上传文件的进度条 -->
<script>
    $(function () {
    	var projectName='${finacingInfo.projectName}';
    	if(projectName==''){
    		document.getElementById("select_content").click();
    		
    	}
    	//调用拼接机构的方法${investorIdList}${investorNameList}
    	if(""!=="${investorIdList}"){
    		investorIdList='${investorIdList}';
    		investorNameList='${investorNameList}';
    		get_investor_record(); 
    	}
        //调用日期控件
        var laydate = layui.laydate;
        laydate.render({
            elem: '#focusDate' //指定元素
            , min: 0
        });
        //文本框控制结束
        //上传文件控件
        var upload = layui.upload;
        //指定允许上传的文件类型
        upload.render({
            elem: '#updateFile'
//             , exts: 'jpg|jpeg|png|bmp|gif|txt|TXT|xls|XLS|xlsx|docx|doc|pdf'
            // ,url: '/SRRPBusinesWeb/finacingDemand/fileUpload'
            ,data : {"fileType" : 'syjh'}
            , url: '/SRRPBusinesWeb/index/fileUpload' //上传接口
            , accept: 'file' //普通文件
            , auto: false
            , size: 1024 * 128  //设置文件上传的大小最大为128M
            , before: function () {
                $("#downloadFile").text("文件上传中请稍候…………");
                document.getElementById("downloadFile").style.color = '#FF6838';
            }
            ,choose: function(obj){
                //将每次选择的文件追加到文件队列
                var files = obj.pushFile();
                //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function(index, file, result){
                  if(file.size == 0){
                	  $("#downloadFile").text("请上传非空文件！");
                	  document.getElementById("downloadFile").style.color = '#FF6838';
                  }else{
                	  obj.upload(index, file);
                  }
                });
              }
            , done: function (res) {
                if (res.code == 0) {
                	layer.msg(res.name + "上传成功了", {icon: 1});
                    document.getElementById("downloadFile").style.color = 'black';
                    $("#fileupHidden").attr("value", res.url);
                    $("#fileName").attr("value", res.name);
                    $("#downloadFile").text(res.name)
                    $("#downloadFile").attr("href",res.url);
                    $('#downloadFile').attr('download',res.name);
                }else{
                	$("#downloadFile").text("请上传非空文件！");
                }
            }
        });
    })
</script>
</body>
</html>